<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futons Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fd79a8;
            --background: #0c0c0c;
            --surface: #1a1a1a;
            --text: #ffffff;
            --text-secondary: #b8b8b8;
            --border: #333;
            --success: #00b894;
            --warning: #fdcb6e;
            --error: #e17055;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--surface);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .header h1 {
            color: var(--primary);
            font-size: 2rem;
        }

        .logout-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #d63031;
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: var(--surface);
            border-radius: 10px;
            padding: 5px;
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--border);
            color: var(--text);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: var(--surface);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.2);
        }

        .form-group input[type="file"] {
            padding: 8px;
            background: var(--surface);
            border: 2px dashed var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-group input[type="file"]:hover {
            border-color: var(--primary);
            background: rgba(108, 92, 231, 0.05);
        }

        .file-info {
            display: block;
            margin-top: 5px;
            color: var(--text-secondary);
            font-size: 12px;
            font-style: italic;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #4a4a4a;
        }

        .btn-danger {
            background: var(--error);
        }

        .btn-danger:hover {
            background: #d63031;
        }

        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(108, 92, 231, 0.05);
        }

        .file-upload.dragover {
            border-color: var(--primary);
            background: rgba(108, 92, 231, 0.1);
        }

        .file-upload input {
            display: none;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .item-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .item-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .item-card p {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .photo-item:hover img {
            transform: scale(1.05);
        }

        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: var(--surface);
            padding: 40px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .login-form h2 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert-success {
            background: rgba(0, 184, 148, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .alert-warning {
            background: rgba(253, 203, 110, 0.2);
            border-color: var(--warning);
            color: var(--warning);
        }

        .alert-error {
            background: rgba(225, 112, 85, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        /* Photo Preview Styles */
        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .photo-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 6px;
            overflow: hidden;
            background: var(--background);
            border: 1px solid var(--border);
        }

        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .photo-preview-item .remove-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
            transition: opacity 0.2s ease;
        }

        .photo-preview-item .remove-photo:hover {
            opacity: 1;
            background: #d63031;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .tabs {
                flex-direction: column;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginForm" class="login-form">
        <h2>üé∏ Futons Admin Login</h2>
        <div id="loginError" class="alert alert-error hidden"></div>
        <form id="loginFormElement">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">Login</button>
        </form>
        <p style="margin-top: 20px; text-align: center; color: var(--text-secondary); font-size: 14px;">
            Default credentials: admin / admin123
        </p>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="container">
            <div class="header">
                <h1>üé∏ Futons Admin Panel</h1>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>

                        <div class="tabs">
                <button class="tab" data-tab="photos" class="active">Photo Upload</button>
                <button class="tab" data-tab="concerts">Concerts</button>
                <button class="tab" data-tab="music">Music</button>
            </div>

            <!-- Concerts Tab -->
            <div id="concerts" class="tab-content">
                <div class="section">
                    <h2>Add New Concert</h2>
                    <form id="concertForm">
                        <div class="form-group">
                            <label for="concertTitle">Concert Title</label>
                            <input type="text" id="concertTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="concertDate">Date</label>
                            <input type="text" id="concertDate" placeholder="June 15, 2025" required>
                        </div>
                        <div class="form-group">
                            <label for="concertVenue">Venue</label>
                            <input type="text" id="concertVenue" required>
                        </div>
                        <div class="form-group">
                            <label for="concertBooking">Booking URL</label>
                            <input type="url" id="concertBooking" placeholder="https://...">
                        </div>
                        <button type="submit" class="btn">Add Concert</button>
                    </form>
                </div>

                <div class="section">
                    <h2>Upcoming Concerts</h2>
                    <div id="concertsList" class="items-grid"></div>
                </div>
            </div>

            <!-- Music Tab -->
            <div id="music" class="tab-content">
                <div class="section">
                    <h2>Add New Track</h2>
                    <form id="musicForm">
                        <div class="form-group">
                            <label for="trackTitle">Track Title</label>
                            <input type="text" id="trackTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="trackRelease">Release Date</label>
                            <input type="text" id="trackRelease" placeholder="January 2025">
                        </div>
                        <div class="form-group">
                            <label for="trackGenre">Genre</label>
                            <input type="text" id="trackGenre" placeholder="Indie Pop">
                        </div>
                        <div class="form-group">
                            <label for="trackSpotify">Spotify URL</label>
                            <input type="url" id="trackSpotify" placeholder="https://open.spotify.com/...">
                        </div>
                        <button type="submit" class="btn">Add Track</button>
                    </form>
                </div>

                <div class="section">
                    <h2>Music Library</h2>
                    <div id="musicList" class="items-grid"></div>
                </div>
            </div>

            <!-- Photos Tab -->
            <div id="photos" class="tab-content active">
                <div class="section">
                    <h2>Create New Album & Upload Photos</h2>
                    <form id="albumForm">
                        <div class="form-group">
                            <label for="albumTitle">Album Title</label>
                            <input type="text" id="albumTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="albumDescription">Description</label>
                            <textarea id="albumDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="albumCover">Cover Image</label>
                            <input type="file" id="albumCover" accept="image/*" required>
                            <small class="file-info">Choose an image file for the album cover (Max 100MB)</small>
                        </div>
                        
                        <h3 style="margin: 30px 0 15px 0; color: var(--primary);">Album Photos</h3>
                        <div class="file-upload" id="albumFileUpload">
                            <input type="file" id="albumPhotosInput" accept="image/*" multiple>
                            <p>üì∏ Click here or drag and drop photos for this album</p>
                            <p style="color: var(--text-secondary); font-size: 14px; margin-top: 10px;">
                                Supports: JPG, PNG, WebP (Max 100MB each)
                            </p>
                        </div>
                        
                        <div id="stagedPhotos" class="staged-photos">
                            <h4>Staged Photos (<span id="photoCount">0</span>)</h4>
                            <div id="photoPreview" class="photo-preview-grid"></div>
                        </div>
                        
                        <div class="album-actions">
                            <button type="button" class="btn btn-secondary" onclick="admin.clearStagedPhotos()">Clear Photos</button>
                            <button type="submit" class="btn">Create Album & Publish Photos</button>
                        </div>
                    </form>
                </div>

                <div class="section">
                    <h2>Existing Albums</h2>
                    <div style="margin-bottom: 10px;">
                        <button onclick="window.testAdmin()" class="btn btn-secondary">üß™ Test Admin Object</button>
                        <button onclick="console.log('Simple click test works!')" class="btn btn-secondary">üî¨ Test Click</button>
                    </div>
                    <div id="albumsList" class="items-grid"></div>
                </div>

                <div class="section">
                    <h2>Add Photos to Existing Album</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        üí° <strong>Tip:</strong> Select an album below first, then upload photos to automatically add them to that album!
                    </p>
                    <div class="form-group">
                        <label for="selectAlbum">Select Album</label>
                        <select id="selectAlbum">
                            <option value="">Choose an album...</option>
                        </select>
                    </div>
                    
                    <div class="file-upload" id="fileUpload">
                        <input type="file" id="fileInput" accept="image/*" multiple>
                        <p>üì∏ Click here or drag and drop photos</p>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 10px;">
                            Supports: JPG, PNG, WebP (Max 100MB each)
                        </p>
                    </div>

                    <div id="albumPhotos" class="photo-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdminPanel {
            constructor() {
                this.token = localStorage.getItem('adminToken');
                this.baseUrl = window.location.origin;
                this.init();
            }

            init() {
                if (this.token) {
                    this.showAdminPanel();
                    this.loadContent();
                } else {
                    this.showLoginForm();
                }

                this.setupEventListeners();
            }

            setupEventListeners() {
                // Initialize staged photos array
                this.stagedPhotos = [];

                // Login form
                document.getElementById('loginFormElement').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.logout();
                });

                // Tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchTab(tab.dataset.tab);
                    });
                });

                // Forms
                document.getElementById('albumForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addAlbum();
                });

                document.getElementById('concertForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addConcert();
                });

                document.getElementById('musicForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addMusic();
                });

                // File upload
                const fileUpload = document.getElementById('fileUpload');
                const fileInput = document.getElementById('fileInput');

                fileUpload.addEventListener('click', () => fileInput.click());
                fileUpload.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUpload.classList.add('dragover');
                });
                fileUpload.addEventListener('dragleave', () => {
                    fileUpload.classList.remove('dragover');
                });
                fileUpload.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUpload.classList.remove('dragover');
                    this.handleFileUpload(e.dataTransfer.files);
                });

                fileInput.addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files);
                });

                // Album selection for photo management
                document.getElementById('selectAlbum').addEventListener('change', (e) => {
                    this.loadAlbumPhotos(e.target.value);
                });
            }

            /**
             * Initialize the album photo staging system
             * Sets up drag-and-drop and file selection for album creation
             */
            initAlbumPhotoStaging() {
                console.log('Initializing album photo staging...');
                
                // Initialize staged photos array
                this.stagedPhotos = [];
                
                const albumFileUpload = document.getElementById('albumFileUpload');
                const albumPhotosInput = document.getElementById('albumPhotosInput');

                console.log('Album file upload element:', albumFileUpload);
                console.log('Album photos input element:', albumPhotosInput);

                if (!albumFileUpload || !albumPhotosInput) {
                    console.error('Album photo staging elements not found!');
                    return;
                }

                // Click to select files
                albumFileUpload.addEventListener('click', (e) => {
                    if (e.target === albumFileUpload) {
                        albumPhotosInput.click();
                    }
                });

                // Drag and drop handlers
                albumFileUpload.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    albumFileUpload.style.borderColor = 'var(--accent)';
                    albumFileUpload.style.backgroundColor = 'rgba(218, 165, 32, 0.15)';
                });

                albumFileUpload.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    albumFileUpload.style.borderColor = 'var(--primary)';
                    albumFileUpload.style.backgroundColor = 'transparent';
                });

                albumFileUpload.addEventListener('drop', (e) => {
                    e.preventDefault();
                    albumFileUpload.style.borderColor = 'var(--primary)';
                    albumFileUpload.style.backgroundColor = 'transparent';
                    this.handleAlbumPhotos(e.dataTransfer.files);
                });

                // File input change handler
                albumPhotosInput.addEventListener('change', (e) => {
                    this.handleAlbumPhotos(e.target.files);
                });
            }

            /**
             * Handle photos selected for album staging
             * @param {FileList} files - Files selected by user
             */
            handleAlbumPhotos(files) {
                console.log('handleAlbumPhotos called with', files.length, 'files');
                const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
                const maxSize = 100 * 1024 * 1024; // 100MB

                Array.from(files).forEach(file => {
                    console.log('Processing file:', file.name, 'Size:', file.size, 'Type:', file.type);
                    
                    // Validate file type
                    if (!validTypes.includes(file.type)) {
                        this.showAlert(`"${file.name}" is not a valid image type. Please use JPG, PNG, or WebP.`, 'error');
                        return;
                    }

                    // Validate file size
                    if (file.size > maxSize) {
                        this.showAlert(`"${file.name}" is too large. Maximum size is 100MB.`, 'error');
                        return;
                    }

                    // Check if file already staged
                    if (this.stagedPhotos.some(staged => staged.name === file.name && staged.size === file.size)) {
                        this.showAlert(`"${file.name}" is already staged.`, 'warning');
                        return;
                    }

                    // Add to staged photos
                    this.stagedPhotos.push(file);
                });

                this.updatePhotoPreview();
            }

            /**
             * Update the photo preview grid
             */
            updatePhotoPreview() {
                const previewGrid = document.getElementById('photoPreview');
                const photoCount = document.getElementById('photoCount');
                
                if (!previewGrid || !photoCount) return;

                photoCount.textContent = this.stagedPhotos.length;

                previewGrid.innerHTML = this.stagedPhotos.map((file, index) => `
                    <div class="photo-preview-item">
                        <img src="${URL.createObjectURL(file)}" alt="${file.name}">
                        <button class="remove-photo" onclick="admin.removeStagedPhoto(${index})" title="Remove photo">
                            √ó
                        </button>
                    </div>
                `).join('');
            }

            /**
             * Remove a photo from staging
             * @param {number} index - Index of photo to remove
             */
            removeStagedPhoto(index) {
                if (index >= 0 && index < this.stagedPhotos.length) {
                    this.stagedPhotos.splice(index, 1);
                    this.updatePhotoPreview();
                }
            }

            /**
             * Clear all staged photos
             */
            clearStagedPhotos() {
                this.stagedPhotos = [];
                this.updatePhotoPreview();
                document.getElementById('albumPhotosInput').value = '';
                this.showAlert('All staged photos cleared.', 'info');
            }

            async login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('loginError');

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.token = data.token;
                        localStorage.setItem('adminToken', this.token);
                        this.showAdminPanel();
                    } else {
                        errorDiv.textContent = data.error || 'Login failed';
                        errorDiv.classList.remove('hidden');
                    }
                } catch (error) {
                    errorDiv.textContent = 'Connection error. Please try again.';
                    errorDiv.classList.remove('hidden');
                }
            }

            logout() {
                this.token = null;
                localStorage.removeItem('adminToken');
                this.showLoginForm();
            }

            showLoginForm() {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
            }

            showAdminPanel() {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                this.loadData();
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');

                // Load specific data
                if (tabName === 'photos') {
                    this.loadAlbumOptions();
                }
            }

            async makeRequest(url, options = {}) {
                const defaultOptions = {
                    headers: {
                        'Authorization': `Bearer ${this.token}`
                    }
                };

                // Only add Content-Type for JSON requests, not for FormData
                if (options.body && typeof options.body === 'string') {
                    defaultOptions.headers['Content-Type'] = 'application/json';
                }

                const mergedOptions = {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        ...options.headers
                    }
                };

                const response = await fetch(url, mergedOptions);
                
                if (response.status === 401) {
                    this.logout();
                    return null;
                }

                return response;
            }

            async loadData() {
                await Promise.all([
                    this.loadAlbums(),
                    this.loadConcerts(),
                    this.loadMusic()
                ]);
                
                // Initialize album photo staging after all data is loaded
                this.initAlbumPhotoStaging();
            }

            async loadAlbums() {
                try {
                    const response = await fetch('/api/albums');
                    const albums = await response.json();
                    this.displayAlbums(albums);
                } catch (error) {
                    console.error('Error loading albums:', error);
                }
            }

            async loadConcerts() {
                try {
                    const response = await fetch('/api/concerts');
                    const concerts = await response.json();
                    this.displayConcerts(concerts);
                } catch (error) {
                    console.error('Error loading concerts:', error);
                }
            }

            async loadMusic() {
                try {
                    const response = await fetch('/api/music');
                    const music = await response.json();
                    this.displayMusic(music);
                } catch (error) {
                    console.error('Error loading music:', error);
                }
            }

            displayAlbums(albums) {
                console.log('üéØ displayAlbums called with:', albums);
                const container = document.getElementById('albumsList');
                container.innerHTML = albums.map(album => `
                    <div class="item-card">
                        <h3>${album.title}</h3>
                        <p>${album.description}</p>
                        <p><strong>Cover:</strong> ${album.coverImage || 'No cover set'}</p>
                        <p><strong>Photos:</strong> ${album.photos.length} images</p>
                        <div class="item-actions">
                            <button class="btn btn-secondary edit-album-btn" data-album-id="${album.id}">Edit</button>
                            <button class="btn btn-danger delete-album-btn" data-album-id="${album.id}">Delete</button>
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to all edit buttons
                document.querySelectorAll('.edit-album-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const albumId = e.target.getAttribute('data-album-id');
                        console.log('‚úèÔ∏è Edit button clicked for album:', albumId);
                        this.editAlbum(albumId);
                    });
                });
                
                // Add event listeners to all delete buttons
                document.querySelectorAll('.delete-album-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const albumId = e.target.getAttribute('data-album-id');
                        console.log('üóëÔ∏è Delete button clicked for album:', albumId);
                        this.deleteAlbum(albumId);
                    });
                });
                
                console.log('üéØ Albums displayed successfully with event listeners attached');
            }

            displayConcerts(concerts) {
                console.log('üéµ displayConcerts called with:', concerts);
                const container = document.getElementById('concertsList');
                container.innerHTML = concerts.map(concert => `
                    <div class="item-card">
                        <h3>${concert.title}</h3>
                        <p><strong>Date:</strong> ${concert.date}</p>
                        <p><strong>Venue:</strong> ${concert.venue}</p>
                        <p><strong>Booking:</strong> ${concert.bookingUrl ? 'Available' : 'Not set'}</p>
                        <div class="item-actions">
                            <button class="btn btn-secondary edit-concert-btn" data-concert-id="${concert.id}">Edit</button>
                            <button class="btn btn-danger delete-concert-btn" data-concert-id="${concert.id}">Delete</button>
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to all edit buttons
                document.querySelectorAll('.edit-concert-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const concertId = e.target.getAttribute('data-concert-id');
                        console.log('‚úèÔ∏è Edit concert button clicked for:', concertId);
                        this.editConcert(concertId);
                    });
                });
                
                // Add event listeners to all delete buttons
                document.querySelectorAll('.delete-concert-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const concertId = e.target.getAttribute('data-concert-id');
                        console.log('üóëÔ∏è Delete concert button clicked for:', concertId);
                        this.deleteConcert(concertId);
                    });
                });
                
                console.log('üéµ Concerts displayed successfully with event listeners attached');
            }

            displayMusic(music) {
                console.log('üé∂ displayMusic called with:', music);
                const container = document.getElementById('musicList');
                container.innerHTML = music.map(track => `
                    <div class="item-card">
                        <h3>${track.title}</h3>
                        <p><strong>Release:</strong> ${track.releaseDate || 'TBA'}</p>
                        <p><strong>Genre:</strong> ${track.genre}</p>
                        <p><strong>Spotify:</strong> ${track.spotifyUrl ? 'Available' : 'Not set'}</p>
                        <div class="item-actions">
                            <button class="btn btn-secondary edit-music-btn" data-music-id="${track.id}">Edit</button>
                            <button class="btn btn-danger delete-music-btn" data-music-id="${track.id}">Delete</button>
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to all edit buttons
                document.querySelectorAll('.edit-music-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const musicId = e.target.getAttribute('data-music-id');
                        console.log('‚úèÔ∏è Edit music button clicked for:', musicId);
                        this.editMusic(musicId);
                    });
                });
                
                // Add event listeners to all delete buttons
                document.querySelectorAll('.delete-music-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const musicId = e.target.getAttribute('data-music-id');
                        console.log('üóëÔ∏è Delete music button clicked for:', musicId);
                        this.deleteMusic(musicId);
                    });
                });
                
                console.log('üé∂ Music displayed successfully with event listeners attached');
            }

            async addAlbum() {
                console.log('üîç Starting addAlbum function');
                
                const title = document.getElementById('albumTitle').value;
                const description = document.getElementById('albumDescription').value;
                const coverImageFile = document.getElementById('albumCover').files[0];
                const form = document.getElementById('albumForm');
                const isEditing = form.dataset.editId;

                console.log('üìù Form data:', { title, description, hasCoverImage: !!coverImageFile, stagedPhotosCount: this.stagedPhotos.length, isEditing });

                // If editing, we don't require a new cover image
                if (!isEditing && !coverImageFile) {
                    this.showAlert('Please select a cover image', 'error');
                    return;
                }

                // If editing, we don't require staged photos (they can update just the text)
                if (!isEditing && this.stagedPhotos.length === 0) {
                    this.showAlert('Please add at least one photo to the album', 'error');
                    return;
                }

                try {
                    let coverImagePath = null;
                    
                    if (isEditing) {
                        console.log('‚úèÔ∏è Editing existing album');
                        this.showAlert('Updating album...', 'info');
                        
                        // For editing, only upload new cover if provided
                        if (coverImageFile) {
                            console.log('üì∏ Uploading new cover image');
                            const coverFormData = new FormData();
                            coverFormData.append('photo', coverImageFile);

                            const uploadResponse = await this.makeRequest('/api/upload', {
                                method: 'POST',
                                body: coverFormData
                            });

                            if (!uploadResponse.ok) {
                                throw new Error('Failed to upload new cover image');
                            }

                            const uploadResult = await uploadResponse.json();
                            coverImagePath = uploadResult.imagePath;
                            console.log('‚úÖ Cover image uploaded:', coverImagePath);
                        }
                        
                        // Update the album
                        const updateData = { title, description };
                        if (coverImagePath) {
                            updateData.coverImage = coverImagePath;
                        }
                        
                        console.log('üîÑ Updating album with data:', updateData);
                        const albumResponse = await this.makeRequest(`/api/albums/${isEditing}`, {
                            method: 'PUT',
                            body: JSON.stringify(updateData)
                        });

                        if (!albumResponse || !albumResponse.ok) {
                            throw new Error('Failed to update album');
                        }

                        this.showAlert(`üéâ Album "${title}" updated successfully!`, 'success');
                        
                    } else {
                        console.log('üÜï Creating new album');
                        this.showAlert('Creating album and uploading photos...', 'info');

                        // Step 1: Upload the cover image
                        console.log('üì∏ Uploading cover image');
                        const coverFormData = new FormData();
                        coverFormData.append('photo', coverImageFile);

                        const uploadResponse = await this.makeRequest('/api/upload', {
                            method: 'POST',
                            body: coverFormData
                        });

                        console.log('üì∏ Cover upload response status:', uploadResponse.status);
                        if (!uploadResponse.ok) {
                            const errorText = await uploadResponse.text();
                            console.error('Cover upload error:', errorText);
                            throw new Error('Failed to upload cover image: ' + errorText);
                        }

                        const uploadResult = await uploadResponse.json();
                        coverImagePath = uploadResult.imagePath;
                        console.log('‚úÖ Cover image uploaded:', coverImagePath);

                        // Step 2: Create the album
                        console.log('üóÇÔ∏è Creating album');
                        const albumData = { title, description, coverImage: coverImagePath };
                        console.log('Album data being sent:', albumData);
                        
                        const albumResponse = await this.makeRequest('/api/albums', {
                            method: 'POST',
                            body: JSON.stringify(albumData)
                        });

                        console.log('üóÇÔ∏è Album creation response status:', albumResponse.status);
                        if (!albumResponse || !albumResponse.ok) {
                            const errorText = await albumResponse.text();
                            console.error('Album creation error:', errorText);
                            throw new Error('Failed to create album: ' + errorText);
                        }

                        const albumResult = await albumResponse.json();
                        const albumId = albumResult.album.id;
                        console.log('‚úÖ Album created with ID:', albumId);

                        // Step 3: Upload all staged photos to the album
                        let uploadedCount = 0;
                        const totalPhotos = this.stagedPhotos.length;
                        console.log(`üì∑ Starting to upload ${totalPhotos} photos`);

                        for (let i = 0; i < this.stagedPhotos.length; i++) {
                            const photo = this.stagedPhotos[i];
                            const photoFormData = new FormData();
                            photoFormData.append('photo', photo);
                            photoFormData.append('albumId', albumId);

                            try {
                                console.log(`üì∑ Uploading photo ${i + 1}/${totalPhotos}: ${photo.name}`);
                                const photoResponse = await this.makeRequest('/api/upload', {
                                    method: 'POST',
                                    body: photoFormData
                                });

                                if (photoResponse && photoResponse.ok) {
                                    uploadedCount++;
                                    console.log(`‚úÖ Photo uploaded: ${photo.name}`);
                                    this.showAlert(`Uploading photos... ${uploadedCount}/${totalPhotos}`, 'info');
                                } else {
                                    const errorText = await photoResponse.text();
                                    console.error(`‚ùå Failed to upload photo: ${photo.name}`, errorText);
                                }
                            } catch (error) {
                                console.error(`‚ùå Error uploading photo ${photo.name}:`, error);
                            }
                        }

                        console.log(`‚úÖ Album creation complete! Uploaded ${uploadedCount}/${totalPhotos} photos`);
                        this.showAlert(`üéâ Album "${title}" created successfully with ${uploadedCount} photos!`, 'success');
                    }

                    // Reset form and staged photos
                    console.log('üßπ Cleaning up form and staged photos');
                    document.getElementById('albumForm').reset();
                    delete form.dataset.editId;
                    form.querySelector('button[type="submit"]').textContent = 'Create Album & Publish Photos';
                    this.clearStagedPhotos();
                    this.loadAlbums();
                    console.log('‚úÖ Album operation completed successfully');

                } catch (error) {
                    console.error('‚ùå Error with album operation:', error);
                    this.showAlert('Error: ' + error.message, 'error');
                }
            }

            async addConcert() {
                const title = document.getElementById('concertTitle').value;
                const date = document.getElementById('concertDate').value;
                const venue = document.getElementById('concertVenue').value;
                const bookingUrl = document.getElementById('concertBooking').value;

                try {
                    const response = await this.makeRequest('/api/concerts', {
                        method: 'POST',
                        body: JSON.stringify({ title, date, venue, bookingUrl })
                    });

                    if (response && response.ok) {
                        this.showAlert('Concert added successfully!', 'success');
                        document.getElementById('concertForm').reset();
                        this.loadConcerts();
                    }
                } catch (error) {
                    this.showAlert('Error adding concert', 'error');
                }
            }

            async addMusic() {
                const title = document.getElementById('trackTitle').value;
                const releaseDate = document.getElementById('trackRelease').value;
                const genre = document.getElementById('trackGenre').value;
                const spotifyUrl = document.getElementById('trackSpotify').value;

                try {
                    const response = await this.makeRequest('/api/music', {
                        method: 'POST',
                        body: JSON.stringify({ title, releaseDate, genre, spotifyUrl })
                    });

                    if (response && response.ok) {
                        this.showAlert('Track added successfully!', 'success');
                        document.getElementById('musicForm').reset();
                        this.loadMusic();
                    }
                } catch (error) {
                    this.showAlert('Error adding track', 'error');
                }
            }

            async handleFileUpload(files) {
                const progressDiv = document.getElementById('uploadProgress');
                const selectedAlbum = document.getElementById('selectAlbum').value;
                
                if (progressDiv) {
                    progressDiv.classList.remove('hidden');
                }

                for (let file of files) {
                    if (file.size > 100 * 1024 * 1024) { // 100MB
                        this.showAlert(`File ${file.name} is too large (max 100MB)`, 'error');
                        continue;
                    }

                    const formData = new FormData();
                    formData.append('photo', file);

                    try {
                        // Upload the photo first
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: formData
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.showAlert(`${file.name} uploaded successfully!`, 'success');
                            
                            // If an album is selected, add the photo to that album
                            if (selectedAlbum) {
                                try {
                                    const addToAlbumResponse = await this.makeRequest(`/api/albums/${selectedAlbum}/photos`, {
                                        method: 'POST',
                                        body: JSON.stringify({ photoPath: data.imagePath })
                                    });
                                    
                                    if (addToAlbumResponse && addToAlbumResponse.ok) {
                                        this.showAlert(`${file.name} added to album!`, 'success');
                                        // Refresh the album photos display if viewing the same album
                                        const viewingAlbum = document.getElementById('selectAlbum').value;
                                        if (viewingAlbum === selectedAlbum) {
                                            this.loadAlbumPhotos(selectedAlbum);
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error adding photo to album:', error);
                                    this.showAlert(`${file.name} uploaded but not added to album`, 'warning');
                                }
                            }
                        } else {
                            this.showAlert(`Error uploading ${file.name}`, 'error');
                        }
                    } catch (error) {
                        this.showAlert(`Error uploading ${file.name}`, 'error');
                    }
                }

                progressDiv.classList.add('hidden');
                document.getElementById('fileInput').value = '';
            }

            async loadAlbumOptions() {
                try {
                    const response = await fetch('/api/albums');
                    const albums = await response.json();
                    
                    // Update the album management selector
                    const select = document.getElementById('selectAlbum');
                    select.innerHTML = '<option value="">Choose an album...</option>' +
                        albums.map(album => `<option value="${album.id}">${album.title}</option>`).join('');
                    
                    // Update the upload album selector
                    const uploadSelect = document.getElementById('uploadSelectAlbum');
                    if (uploadSelect) {
                        uploadSelect.innerHTML = '<option value="">Upload without adding to album</option>' +
                            albums.map(album => `<option value="${album.id}">${album.title}</option>`).join('');
                    }
                } catch (error) {
                    console.error('Error loading album options:', error);
                }
            }

            async loadAlbumPhotos(albumId) {
                if (!albumId) {
                    document.getElementById('albumPhotos').innerHTML = '';
                    return;
                }

                try {
                    const response = await fetch('/api/albums');
                    const albums = await response.json();
                    const album = albums.find(a => a.id === albumId);
                    
                    if (album) {
                        const container = document.getElementById('albumPhotos');
                        container.innerHTML = album.photos.map(photo => `
                            <div class="photo-item">
                                <img src="${photo}" alt="Album photo">
                                <div class="photo-actions">
                                    <button class="delete-photo" onclick="admin.removePhoto('${albumId}', '${photo}')" title="Remove photo">
                                        √ó
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Error loading album photos:', error);
                }
            }

            async removePhoto(albumId, photoPath) {
                if (!confirm('Remove this photo from the album?')) return;

                try {
                    const response = await this.makeRequest(`/api/albums/${albumId}/photos`, {
                        method: 'DELETE',
                        body: JSON.stringify({ photoPath })
                    });

                    if (response && response.ok) {
                        this.showAlert('Photo removed successfully!', 'success');
                        this.loadAlbumPhotos(albumId);
                    }
                } catch (error) {
                    this.showAlert('Error removing photo', 'error');
                }
            }

            async deleteAlbum(id) {
                console.log('deleteAlbum called with id:', id);
                if (!confirm('Delete this album? This cannot be undone.')) return;

                try {
                    const response = await this.makeRequest(`/api/albums/${id}`, {
                        method: 'DELETE'
                    });

                    console.log('Delete response:', response);

                    if (response && response.ok) {
                        this.showAlert('Album deleted successfully!', 'success');
                        this.loadAlbums();
                    }
                } catch (error) {
                    console.error('Error in deleteAlbum:', error);
                    this.showAlert('Error deleting album', 'error');
                }
            }

            async deleteConcert(id) {
                if (!confirm('Delete this concert? This cannot be undone.')) return;

                try {
                    const response = await this.makeRequest(`/api/concerts/${id}`, {
                        method: 'DELETE'
                    });

                    if (response && response.ok) {
                        this.showAlert('Concert deleted successfully!', 'success');
                        this.loadConcerts();
                    }
                } catch (error) {
                    this.showAlert('Error deleting concert', 'error');
                }
            }

            async deleteMusic(id) {
                if (!confirm('Delete this track? This cannot be undone.')) return;

                try {
                    const response = await this.makeRequest(`/api/music/${id}`, {
                        method: 'DELETE'
                    });

                    if (response && response.ok) {
                        this.showAlert('Track deleted successfully!', 'success');
                        this.loadMusic();
                    }
                } catch (error) {
                    this.showAlert('Error deleting track', 'error');
                }
            }

            showAlert(message, type) {
                // Create a temporary alert
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.textContent = message;
                alert.style.position = 'fixed';
                alert.style.top = '20px';
                alert.style.right = '20px';
                alert.style.zIndex = '9999';
                alert.style.maxWidth = '300px';

                document.body.appendChild(alert);

                setTimeout(() => {
                    alert.remove();
                }, 4000);
            }

            // Edit functionality for albums
            async editAlbum(id) {
                console.log('editAlbum called with id:', id);
                try {
                    const response = await fetch('/api/albums');
                    const albums = await response.json();
                    const album = albums.find(a => a.id === id);
                    
                    console.log('Found album:', album);
                    
                    if (album) {
                        // Pre-populate the form with current album data
                        document.getElementById('albumTitle').value = album.title;
                        document.getElementById('albumDescription').value = album.description;
                        
                        // Switch to photos tab
                        this.switchTab('photos');
                        
                        // Scroll to form
                        document.getElementById('albumForm').scrollIntoView({ behavior: 'smooth' });
                        
                        // Change the form submit to update instead of create
                        const form = document.getElementById('albumForm');
                        form.dataset.editId = id;
                        
                        // Update button text
                        const submitBtn = form.querySelector('button[type="submit"]');
                        submitBtn.textContent = 'Update Album';
                        
                        this.showAlert(`Editing album: ${album.title}`, 'info');
                    }
                } catch (error) {
                    console.error('Error in editAlbum:', error);
                    this.showAlert('Error loading album for editing', 'error');
                }
            }

            editConcert(id) {
                this.showAlert('Edit functionality coming soon!', 'warning');
            }

            editMusic(id) {
                this.showAlert('Edit functionality coming soon!', 'warning');
            }
        }

        // Initialize admin panel and make it globally accessible
        const admin = new AdminPanel();
        window.admin = admin; // Make admin accessible to onclick handlers
        
        // Debug function to test admin accessibility
        window.testAdmin = function() {
            console.log('üß™ Testing admin object accessibility:');
            console.log('admin exists:', !!window.admin);
            console.log('admin.editAlbum exists:', typeof window.admin?.editAlbum);
            console.log('admin.deleteAlbum exists:', typeof window.admin?.deleteAlbum);
            console.log('admin object:', window.admin);
        };
        
        // Auto-run debug test after page loads
        setTimeout(() => {
            console.log('üöÄ Admin panel initialized');
            window.testAdmin();
        }, 1000);
    </script>
</body>
</html>
